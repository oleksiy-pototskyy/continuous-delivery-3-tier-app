name: Deploy Infrastructure

on:
  push:
    branches: [main]
    paths: ['terraform/**']
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.13.1

jobs:
  plan:
    runs-on: ubuntu-latest
    outputs:
      plan-exists: ${{ steps.plan.outputs.plan-exists }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          terraform/
        sparse-checkout-cone-mode: false

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Terraform Init
      run: |
        cd terraform
        terraform init

    - name: Terraform Plan
      id: plan
      run: |
        cd terraform
        terraform plan -out=tfplan
        if [ -f tfplan ]; then
          echo "plan-exists=true" >> $GITHUB_OUTPUT
        else
          echo "plan-exists=false" >> $GITHUB_OUTPUT
        fi

    - name: Upload plan
      if: steps.plan.outputs.plan-exists == 'true'
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan
        path: terraform/tfplan
        retention-days: 1

  approve:
    needs: plan
    if: needs.plan.outputs.plan-exists == 'true'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Manual approval required
      run: |
        echo "ğŸ” Terraform plan completed successfully"
        echo "ğŸ“‹ Please review the plan and approve deployment in the GitHub Actions UI"
        echo "âœ… Click 'Approve and deploy' to proceed with terraform apply"
        echo "âŒ Click 'Reject' to stop the deployment"

  apply:
    needs: [plan, approve]
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        sparse-checkout: |
          terraform/
        sparse-checkout-cone-mode: false

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Download plan
      uses: actions/download-artifact@v4
      with:
        name: terraform-plan
        path: terraform/

    - name: Terraform Init
      run: |
        cd terraform
        terraform init

    - name: Terraform Apply
      run: |
        cd terraform
        terraform apply tfplan

    - name: Deployment success
      run: |
        echo "âœ… Infrastructure deployed successfully!"
        echo "ğŸ—ï¸ Terraform apply completed"